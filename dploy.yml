project:
  git_repository: 'git@github.com:ajespa-siae/gestio-accessos.git'
  deploy:
    directory: '/home/siae-accessos/htdocs/accessos.siae.cat'
    shared_directories:
      - 'storage/logs'
      - 'storage/app'
      - 'storage/framework'
      - 'bootstrap/cache'
    before_commands: # Before symlink switch
      # Crear directorios necesarios y establecer permisos
      - 'mkdir -p {release_directory}/bootstrap/cache'
      - 'chmod -R 775 {release_directory}/bootstrap/cache'
      - 'mkdir -p {release_directory}/storage/framework/cache'
      - 'mkdir -p {release_directory}/storage/framework/sessions'
      - 'mkdir -p {release_directory}/storage/framework/views'
      - 'chmod -R 775 {release_directory}/storage'
      
      # Instalar extensión pdo_pgsql si es necesario
      - 'sudo apt-get update && sudo apt-get install -y php8.4-pgsql || true'
      
      # Crear archivo .env directamente en el servidor
      - 'cat > {release_directory}/.env << "EOL"
APP_NAME="Gestió d\'Accessos"
APP_ENV=production
APP_KEY=base64:hjbgRY5bMhvJIxlUxJ+gLqHLJwgH8QyFulCPFLnZ8R4=
APP_DEBUG=false
APP_URL=https://accessos.siae.cat

# PostgreSQL Configuration
DB_CONNECTION=pgsql
DB_HOST=10.0.2.10
DB_PORT=5432
DB_DATABASE=gestio-accessos
DB_USERNAME=siae
DB_PASSWORD=zmqxZY5SXD0tIl5ULi2i

# LDAP Configuration
LDAP_LOGGING=false
LDAP_CONNECTION=default
LDAP_HOST=esparreguera.local
LDAP_USERNAME=escuda@esparreguera.local
LDAP_PASSWORD=Pcrjls4j*
LDAP_PORT=389
LDAP_BASE_DN=dc=esparreguera,dc=local
LDAP_TIMEOUT=5
LDAP_SSL=false
LDAP_TLS=false

# Email Configuration
MAIL_MAILER=smtp
MAIL_HOST=hathor.esparreguera.local
MAIL_PORT=25
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_ENCRYPTION=
MAIL_FROM_ADDRESS=noreply@esparreguera.cat
MAIL_FROM_NAME="SSO Corporativo"

# Queue and Cache
QUEUE_CONNECTION=database
CACHE_DRIVER=file
SESSION_DRIVER=file
SESSION_LIFETIME=120

# Optimizaciones de producción
BROADCAST_DRIVER=log
LOG_CHANNEL=stack
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=error

# Configuración de seguridad
SANCTUM_STATEFUL_DOMAINS=accessos.siae.cat
SESSION_SECURE_COOKIE=true
EOL'
      
      # Instalar dependencias y optimizar
      - 'cd {release_directory} && COMPOSER_ALLOW_SUPERUSER=1 php8.4 /usr/local/bin/composer install --no-dev --optimize-autoloader --no-scripts'
      - 'cd {release_directory} && php8.4 artisan key:generate --force'
      - 'cd {release_directory} && php8.4 artisan storage:link'
      
      # Ejecutar migraciones si la base de datos está configurada correctamente
      - 'cd {release_directory} && php8.4 artisan migrate --force || echo "Error en migraciones, verificar conexión a base de datos"'
      
      # Limpiar todas las cachés y optimizar la aplicación
      - 'cd {release_directory} && php8.4 artisan config:clear'
      - 'cd {release_directory} && php8.4 artisan route:clear'
      - 'cd {release_directory} && php8.4 artisan view:clear'
      - 'cd {release_directory} && php8.4 artisan cache:clear'
      - 'cd {release_directory} && php8.4 artisan optimize:clear'
      - 'cd {release_directory} && php8.4 artisan optimize || echo "Error en optimización, continuando de todos modos"'
      - 'cd {release_directory} && php8.4 artisan queue:restart || echo "Error al reiniciar colas, continuando de todos modos"'
      
      # Establecer permisos correctos
      - 'find {release_directory} -type d -exec chmod 0775 {} \;'
      - 'find {release_directory} -type f -exec chmod 0664 {} \;'
      - 'chown -R siae-accessos:siae-accessos {release_directory}'
    after_commands: # After symlink switch
      - 'sudo systemctl reload php8.4-fpm'
